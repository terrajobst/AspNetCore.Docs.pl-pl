---
title: Zarządzanie kluczami w ASP.NET Core
author: rick-anderson
description: Poznaj szczegóły implementacji interfejsów API zarządzania kluczami ASP.NET Core ochrony danych.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: c571222d734fa69183563aefa5cc6ce5a10e7612
ms.sourcegitcommit: 9a129f5f3e31cc449742b164d5004894bfca90aa
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 03/06/2020
ms.locfileid: "78664711"
---
# <a name="key-management-in-aspnet-core"></a><span data-ttu-id="23963-103">Zarządzanie kluczami w ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="23963-103">Key management in ASP.NET Core</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="23963-104">System ochrony danych automatycznie zarządza okresem istnienia kluczy głównych używanych do ochrony i nieochrony ładunków.</span><span class="sxs-lookup"><span data-stu-id="23963-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="23963-105">Każdy klucz może istnieć w jednym z czterech etapów:</span><span class="sxs-lookup"><span data-stu-id="23963-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="23963-106">Utworzono — klucz istnieje w pęku kluczy, ale nie został jeszcze aktywowany.</span><span class="sxs-lookup"><span data-stu-id="23963-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="23963-107">Klucza nie należy używać w przypadku nowych operacji ochrony, dopóki nie upłynie wystarczająco dużo czasu, że klucz ma szansę na propagację na wszystkie maszyny, które zużywają ten pierścień kluczy.</span><span class="sxs-lookup"><span data-stu-id="23963-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="23963-108">Aktywny — klucz istnieje w pierścieniu kluczy i powinien być używany dla wszystkich nowych operacji ochrony.</span><span class="sxs-lookup"><span data-stu-id="23963-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="23963-109">Wygasł — klucz został uruchomiony jako jego naturalny okres istnienia i nie powinien już być używany dla nowych operacji ochrony.</span><span class="sxs-lookup"><span data-stu-id="23963-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="23963-110">Odwołany — klucz został złamany i nie może być używany dla nowych operacji ochrony.</span><span class="sxs-lookup"><span data-stu-id="23963-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="23963-111">Klucze utworzone, aktywne i wygasłe mogą służyć do wykluczania ochrony przychodzących ładunków.</span><span class="sxs-lookup"><span data-stu-id="23963-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="23963-112">Klucze odwołane domyślnie nie mogą być używane do ochrony ładunków, ale Deweloper aplikacji może [przesłonić to zachowanie](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) w razie potrzeby.</span><span class="sxs-lookup"><span data-stu-id="23963-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="23963-113">Deweloper może być skłonny do usunięcia klucza z pierścienia kluczy (np. przez usunięcie odpowiedniego pliku z systemu plików).</span><span class="sxs-lookup"><span data-stu-id="23963-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="23963-114">W tym momencie wszystkie dane chronione przez klucz są trwale nierozpoznawalne i nie ma żadnych zastąpień awaryjnych, takich jak istnieje odwołanie do unieważnionych kluczy.</span><span class="sxs-lookup"><span data-stu-id="23963-114">At that point, all data protected by the key is permanently undecipherable, and there's no emergency override like there's with revoked keys.</span></span> <span data-ttu-id="23963-115">Usunięcie klucza jest naprawdę zachowaniem destrukcyjnym, a w związku z tym system ochrony danych nie ujawnia interfejsu API pierwszej klasy do wykonania tej operacji.</span><span class="sxs-lookup"><span data-stu-id="23963-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="23963-116">Wybór klucza domyślnego</span><span class="sxs-lookup"><span data-stu-id="23963-116">Default key selection</span></span>

<span data-ttu-id="23963-117">Gdy system ochrony danych odczytuje pierścień kluczy z repozytorium zapasowego, podejmie próbę odnalezienia domyślnego klucza z pierścienia kluczy.</span><span class="sxs-lookup"><span data-stu-id="23963-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="23963-118">Domyślny klucz jest używany dla nowych operacji ochrony.</span><span class="sxs-lookup"><span data-stu-id="23963-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="23963-119">Ogólna heurystyka polega na tym, że system ochrony danych wybiera klucz z najnowszą datą aktywacji jako klucz domyślny.</span><span class="sxs-lookup"><span data-stu-id="23963-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="23963-120">(Istnieje mały fudgey czynnik, który umożliwia przechylenie między serwerami a serwerem). Jeśli klucz wygasł lub został odwołany, a jeśli aplikacja nie wyłączyła automatycznej generacji kluczy, zostanie wygenerowany nowy klucz z natychmiastową aktywacją zgodnie z poniższą opcją [wygaśnięcia klucza i zasadami wycofywania](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) .</span><span class="sxs-lookup"><span data-stu-id="23963-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="23963-121">Od momentu, gdy system ochrony danych generuje nowy klucz bezpośrednio, zamiast powracać do innego klucza, to nowa generacja kluczy powinna być traktowana jako niejawne wygaśnięcie wszystkich kluczy, które zostały aktywowane przed nowym kluczem.</span><span class="sxs-lookup"><span data-stu-id="23963-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="23963-122">Dobrym pomysłem jest to, że nowe klucze mogą zostać skonfigurowane przy użyciu różnych algorytmów lub mechanizmów szyfrowania w trybie spoczynku niż stare klucze, a system powinien preferować bieżącą konfigurację w porównaniu z powrotem.</span><span class="sxs-lookup"><span data-stu-id="23963-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="23963-123">Wystąpił wyjątek.</span><span class="sxs-lookup"><span data-stu-id="23963-123">There's an exception.</span></span> <span data-ttu-id="23963-124">Jeśli deweloper aplikacji [wyłączył automatyczne generowanie kluczy](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), system ochrony danych musi wybrać coś jako klucz domyślny.</span><span class="sxs-lookup"><span data-stu-id="23963-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="23963-125">W tym scenariuszu rezerwowym system wybierze klucz nieodwołany z datą ostatniej aktywacji z preferencjami dotyczącymi kluczy, które miały czas na propagację na inne maszyny w klastrze.</span><span class="sxs-lookup"><span data-stu-id="23963-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="23963-126">System rezerwowy może zakończyć Wybieranie wygasłego klucza domyślnego w wyniku.</span><span class="sxs-lookup"><span data-stu-id="23963-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="23963-127">System rezerwowy nigdy nie wybiera odwołanego klucza jako klucza domyślnego, a jeśli pierścień kluczy jest pusty lub każdy klucz został odwołany, system wygeneruje błąd po zainicjowaniu.</span><span class="sxs-lookup"><span data-stu-id="23963-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="23963-128">Wygaśnięcie i wycofywanie klucza</span><span class="sxs-lookup"><span data-stu-id="23963-128">Key expiration and rolling</span></span>

<span data-ttu-id="23963-129">Po utworzeniu klucza jest on automatycznie miał datę aktywacji {Now + 2 dni} i datę wygaśnięcia {Now + 90 dni}.</span><span class="sxs-lookup"><span data-stu-id="23963-129">When a key is created, it's automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="23963-130">Opóźnienie 2-dniowe przed aktywacją umożliwia przekazanie klucza przez system.</span><span class="sxs-lookup"><span data-stu-id="23963-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="23963-131">Oznacza to, że umożliwia innym aplikacjom wskazanie magazynu zapasowego, aby obserwować klucz w kolejnym okresie autoodświeżania, w ten sposób maksymalizując prawdopodobieństwo, że gdy pierścień klucza stanie się aktywny, został rozpropagowany do wszystkich aplikacji, które mogą wymagać użycia.</span><span class="sxs-lookup"><span data-stu-id="23963-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="23963-132">Jeśli klucz domyślny wygaśnie w ciągu 2 dni i jeśli pierścień kluczy nie ma jeszcze klucza, który będzie aktywny po wygaśnięciu klucza domyślnego, system ochrony danych automatycznie powróci nowy klucz do dzwonka klucza.</span><span class="sxs-lookup"><span data-stu-id="23963-132">If the default key will expire within 2 days and if the key ring doesn't already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="23963-133">Ten nowy klucz ma datę aktywacji {Data wygaśnięcia klucza domyślnego} i datę wygaśnięcia {Now + 90 dni}.</span><span class="sxs-lookup"><span data-stu-id="23963-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="23963-134">Pozwala to systemowi na regularne automatyczne rzutowanie kluczy bez przerwy w działaniu usługi.</span><span class="sxs-lookup"><span data-stu-id="23963-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="23963-135">Mogą wystąpić sytuacje, w których klucz zostanie utworzony z natychmiastową aktywacją.</span><span class="sxs-lookup"><span data-stu-id="23963-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="23963-136">Przykładem może być, gdy aplikacja nie zostanie uruchomiona przez czas, a wszystkie klucze w pęku kluczy wygasły.</span><span class="sxs-lookup"><span data-stu-id="23963-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="23963-137">W takim przypadku klucz otrzymuje datę aktywacji {Now} bez normalnego 2-dniowego opóźnienia aktywacji.</span><span class="sxs-lookup"><span data-stu-id="23963-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="23963-138">Domyślny okres istnienia klucza to 90 dni, ale można go skonfigurować tak, jak w poniższym przykładzie.</span><span class="sxs-lookup"><span data-stu-id="23963-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="23963-139">Administrator może również zmienić domyślne ustawienie całego systemu, chociaż jawne wywołanie `SetDefaultKeyLifetime` przesłoni wszystkie zasady dotyczące całego systemu.</span><span class="sxs-lookup"><span data-stu-id="23963-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="23963-140">Domyślny okres istnienia klucza nie może być krótszy niż 7 dni.</span><span class="sxs-lookup"><span data-stu-id="23963-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="23963-141">Automatyczne odświeżanie dzwonka klucza</span><span class="sxs-lookup"><span data-stu-id="23963-141">Automatic key ring refresh</span></span>

<span data-ttu-id="23963-142">Po zainicjowaniu system ochrony danych odczytuje pierścień klucza z bazowego repozytorium i buforuje go w pamięci.</span><span class="sxs-lookup"><span data-stu-id="23963-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="23963-143">Ta pamięć podręczna umożliwia ochronę i wyłączanie ochrony, aby można było wykonać operację bez nachodzenia do magazynu zapasowego.</span><span class="sxs-lookup"><span data-stu-id="23963-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="23963-144">System automatycznie sprawdzi magazyn zapasowy pod kątem zmian co około 24 godziny lub gdy bieżący klucz domyślny wygaśnie, w zależności od tego, co nastąpi wcześniej.</span><span class="sxs-lookup"><span data-stu-id="23963-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="23963-145">Deweloperzy muszą bardzo rzadko korzystać z interfejsów API zarządzania kluczami.</span><span class="sxs-lookup"><span data-stu-id="23963-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="23963-146">System ochrony danych wykona automatyczne zarządzanie kluczami, zgodnie z powyższym opisem.</span><span class="sxs-lookup"><span data-stu-id="23963-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="23963-147">System ochrony danych uwidacznia interfejs `IKeyManager`, który może służyć do sprawdzania i wprowadzania zmian w pęku kluczy.</span><span class="sxs-lookup"><span data-stu-id="23963-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="23963-148">System DI, który dostarczył wystąpienie `IDataProtectionProvider`, może także zapewnić wystąpienie `IKeyManager` do użycia.</span><span class="sxs-lookup"><span data-stu-id="23963-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="23963-149">Alternatywnie można ściągnąć `IKeyManager` prosto z `IServiceProvider`, jak w poniższym przykładzie.</span><span class="sxs-lookup"><span data-stu-id="23963-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="23963-150">Każda operacja, która modyfikuje pierścień kluczy (utworzenie nowego klucza jawnie lub wykonanie odwołania), spowoduje unieważnienie pamięci podręcznej w pamięci.</span><span class="sxs-lookup"><span data-stu-id="23963-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="23963-151">Następne wywołanie `Protect` lub `Unprotect` spowoduje, że system ochrony danych odczyta ponownie pierścień klucza i ponownie utworzy pamięć podręczną.</span><span class="sxs-lookup"><span data-stu-id="23963-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="23963-152">Poniższy przykład ilustruje użycie interfejsu `IKeyManager` do sprawdzenia i manipulowania pierścieniem kluczy, w tym odwoływanie istniejących kluczy i ręczne generowanie nowego klucza.</span><span class="sxs-lookup"><span data-stu-id="23963-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[](key-management/samples/key-management.cs)]

[!INCLUDE[about the series](~/includes/code-comments-loc.md)]

## <a name="key-storage"></a><span data-ttu-id="23963-153">Magazyn kluczy</span><span class="sxs-lookup"><span data-stu-id="23963-153">Key storage</span></span>

<span data-ttu-id="23963-154">System ochrony danych ma algorytm heurystyczny, przy użyciu którego próbuje automatycznie ustalić odpowiednią lokalizację magazynu kluczy i mechanizm szyfrowania w systemie spoczynku.</span><span class="sxs-lookup"><span data-stu-id="23963-154">The data protection system has a heuristic whereby it attempts to deduce an appropriate key storage location and encryption-at-rest mechanism automatically.</span></span> <span data-ttu-id="23963-155">Mechanizm trwałości klucza jest również konfigurowalny przez dewelopera aplikacji.</span><span class="sxs-lookup"><span data-stu-id="23963-155">The key persistence mechanism is also configurable by the app developer.</span></span> <span data-ttu-id="23963-156">W poniższych dokumentach omówiono implementacje w usłudze Box następujących mechanizmów:</span><span class="sxs-lookup"><span data-stu-id="23963-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* <xref:security/data-protection/implementation/key-storage-providers>
* <xref:security/data-protection/implementation/key-encryption-at-rest>
